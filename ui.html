<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 11px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
    }
    section { margin-bottom: 12px; }
    label { display: block; margin-bottom: 4px; font-weight: 500; }
    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
    }
    input[type="color"] { width: 100%; height: 28px; padding: 0; border: 1px solid var(--figma-color-border); border-radius: 4px; cursor: pointer; }
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      cursor: pointer;
      font-weight: 500;
    }
    button:hover { opacity: 0.9; }
    button.secondary { background: var(--figma-color-bg-secondary); color: var(--figma-color-text); }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .row label { margin-bottom: 0; }
    .icon-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
      flex: 1;
      min-height: 180px;
      max-height: 320px;
      overflow-y: auto;
      padding: 6px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
    }
    .icon-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      background: var(--figma-color-bg);
      border: 1px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      color: var(--figma-color-text);
      text-align: center;
      word-break: break-word;
    }
    .icon-cell:hover { border-color: var(--figma-color-border-strong); background: var(--figma-color-bg-hover); }
    .icon-cell.selected { border-color: var(--figma-color-bg-brand); background: var(--figma-color-bg-brand-tertiary); }
    .icon-cell svg { width: 20px; height: 20px; fill: currentColor; stroke: currentColor; stroke-width: 0.5; flex-shrink: 0; }
    .preview-wrap {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--figma-color-border);
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .preview-wrap .preview-bg {
      position: absolute;
      inset: 0;
      transition: background 0.2s;
    }
    .preview-wrap .preview-icon {
      position: relative;
      z-index: 1;
      width: 48px;
      height: 48px;
    }
    .preview-wrap .preview-icon svg { width: 100%; height: 100%; display: block; }
    .preview-wrap .preview-icon svg path,
    .preview-wrap .preview-icon svg circle { fill: currentColor; stroke: none; }
    .dark-toggle {
      position: absolute;
      top: 6px;
      right: 6px;
      z-index: 2;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px solid var(--figma-color-border);
      background: var(--figma-color-bg);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .dark-toggle:hover { background: var(--figma-color-bg-hover); }
    .stroke-style-tabs { display: flex; gap: 4px; margin-bottom: 8px; }
    .stroke-style-tabs button { flex: 1; padding: 6px 8px; font-size: 10px; }
    .stroke-style-tabs button.active { background: var(--figma-color-bg-brand); color: var(--figma-color-text-onbrand); }
    .scale-options { display: flex; gap: 6px; }
    .scale-options label { display: flex; align-items: center; gap: 4px; cursor: pointer; }
    .scale-options input[type="radio"] { width: auto; }
    .insert-row { margin-top: 12px; display: flex; justify-content: stretch; }
    .insert-row button { flex: 1; }
    .loading { color: var(--figma-color-text-secondary); padding: 8px; }

    /* Material Symbols–style layout */
    .ui-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0 12px;
      border-bottom: 1px solid var(--figma-color-border);
      margin-bottom: 12px;
    }
    .ui-header-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--figma-color-text);
    }
    .ui-header-logo {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      background: linear-gradient(135deg, #4285f4 0%, #ea4335 50%, #fbbc04 100%);
      color: #fff;
      font-size: 12px;
      font-weight: bold;
    }
    .ui-header-close {
      width: 28px;
      height: 28px;
      padding: 0;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--figma-color-text-secondary);
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .ui-header-close:hover {
      background: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
    }
    .search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .style-select-wrap { flex: 0 0 100px; }
    .style-select-wrap label,
    .search-wrap label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 10px; color: var(--figma-color-text-secondary); }
    .search-wrap { flex: 1; min-width: 0; }
    .search-input-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
    }
    .search-input-wrap:focus-within { border-color: var(--figma-color-border-strong); outline: none; }
    .search-input-wrap svg { flex-shrink: 0; width: 14px; height: 14px; stroke: var(--figma-color-text-secondary); }
    .search-input-wrap input {
      border: none;
      background: transparent;
      flex: 1;
      min-width: 0;
      padding: 0;
      font-size: 11px;
      color: var(--figma-color-text);
    }
    .search-input-wrap input::placeholder { color: var(--figma-color-text-secondary); }
    .search-input-wrap input:focus { outline: none; }
    .filters-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 16px;
      margin-bottom: 12px;
    }
    .filter-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 10px;
      color: var(--figma-color-text-secondary);
    }
    .filter-group select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 11px;
    }
    .filter-hint {
      display: block;
      margin-top: 2px;
      font-size: 9px;
      color: var(--figma-color-text-secondary);
    }
    .icon-grid-wrap .icon-grid { margin-bottom: 0; }
    .icon-grid-wrap .section-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 10px;
      color: var(--figma-color-text-secondary);
    }
    /* Two-column: grid left, preview + below right */
    .main-layout {
      display: flex;
      gap: 12px;
      min-height: 0;
    }
    .left-col {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    .icon-grid-wrap { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .right-col {
      width: 160px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--figma-color-border);
      padding-left: 12px;
      transition: width 0.2s ease, padding 0.2s ease, min-width 0.2s ease;
      overflow: hidden;
    }
    .right-col.collapsed {
      width: 36px;
      min-width: 36px;
      padding-left: 4px;
      padding-right: 4px;
      border-left: 1px solid var(--figma-color-border);
    }
    .right-col.collapsed .right-col-content { display: none; }
    .expand-toggle {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      padding: 0;
      border: none;
      border-radius: 4px;
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-secondary);
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
    }
    .expand-toggle:hover { background: var(--figma-color-bg-hover); color: var(--figma-color-text); }
    .right-col.collapsed .expand-toggle { margin-left: 4px; }
    .right-col section { margin-bottom: 10px; }
    .right-col .preview-wrap { min-height: 80px; }
    .right-col .preview-wrap .preview-icon { width: 40px; height: 40px; }
    .icon-cell .cell-svg { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    .icon-cell .cell-svg svg { width: 20px; height: 20px; fill: currentColor; stroke: currentColor; }
    .banner {
      padding: 8px 10px;
      border-radius: 6px;
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 10px;
    }
    .banner strong { color: var(--figma-color-text); }
    .sundial-label { margin-bottom: 6px; font-weight: 500; }
    .sundial-label small { font-weight: normal; color: var(--figma-color-text-secondary); }
    .sundial-swatches { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
    .sundial-swatch {
      width: 28px; height: 28px; border-radius: 6px; border: 2px solid var(--figma-color-border);
      cursor: pointer; flex-shrink: 0;
    }
    .sundial-swatch:hover { border-color: var(--figma-color-border-strong); }
    .sundial-swatch.active { border-color: var(--figma-color-bg-brand); box-shadow: 0 0 0 1px var(--figma-color-bg-brand); }
    .sundial-row { margin-bottom: 6px; }
    .sundial-row span { font-size: 10px; color: var(--figma-color-text-secondary); display: block; margin-bottom: 4px; }
  </style>
</head>
<body>
  <header class="ui-header">
    <div class="ui-header-title">
      <div class="ui-header-logo" title="Material Design">M</div>
      <span>Material Symbols</span>
    </div>
    <button type="button" class="ui-header-close" id="closeBtn" title="Close">×</button>
  </header>

  <div class="main-layout">
    <div class="left-col">
  <div id="limitedBanner" class="banner" style="display:none;">
    <strong>Loading icons from Material Symbols.</strong> If the list is empty, check your network connection and try again.
  </div>

  <div class="search-row">
    <div class="style-select-wrap">
      <label>Style</label>
      <select id="styleSelect">
        <option value="outlined" selected>Outlined</option>
        <option value="rounded">Rounded</option>
        <option value="sharp">Sharp</option>
      </select>
    </div>
    <div class="search-wrap">
      <label for="search">Search</label>
      <div class="search-input-wrap">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <input type="text" id="search" placeholder="Search symbols" />
      </div>
    </div>
  </div>

  <div class="filters-row">
    <div class="filter-group">
      <label for="weightSelect">Weight</label>
      <select id="weightSelect">
        <option value="100">100</option>
        <option value="200">200</option>
        <option value="300">300</option>
        <option value="400" selected>400</option>
        <option value="500">500</option>
        <option value="600">600</option>
        <option value="700">700</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="gradeSelect">Grade</label>
      <select id="gradeSelect">
        <option value="normal" selected>Normal</option>
        <option value="simplified">Simplified</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="fillSelect">Fill</label>
      <select id="fillSelect">
        <option value="off" selected>Off</option>
        <option value="on">On</option>
      </select>
      <span class="filter-hint">Off = stroke-only outline</span>
    </div>
    <div class="filter-group">
      <label for="opticalSelect">Optical size</label>
      <select id="opticalSelect">
        <option value="12">12dp</option>
        <option value="16">16dp</option>
        <option value="20">20dp</option>
        <option value="24" selected>24dp</option>
      </select>
    </div>
  </div>

  <section class="icon-grid-wrap">
    <span class="section-label">Symbols</span>
    <div id="iconGrid" class="icon-grid">
      <div class="loading" id="gridLoading">Loading icons…</div>
    </div>
  </section>
    </div>

    <div class="right-col" id="rightCol">
      <button type="button" class="expand-toggle" id="expandToggle" title="Collapse preview panel">&#9664;</button>
      <div class="right-col-content">
  <section>
    <label>Preview</label>
    <div class="preview-wrap" id="previewWrap">
      <div class="preview-bg" id="previewBg"></div>
      <button type="button" class="dark-toggle" id="darkToggle" title="Toggle light/dark">☀</button>
      <div class="preview-icon" id="previewIcon"></div>
    </div>
  </section>
  <section>
    <label class="sundial-label">Color</label>
    <div id="sundialSwatchesContainer"></div>
    <input type="color" id="strokeColor" value="#855074" />
  </section>
  <section class="insert-row">
    <button type="button" id="insertBtn">Insert on canvas</button>
  </section>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const searchEl = document.getElementById('search');
      const iconGrid = document.getElementById('iconGrid');
      const gridLoading = document.getElementById('gridLoading');
      const previewWrap = document.getElementById('previewWrap');
      const previewBg = document.getElementById('previewBg');
      const previewIcon = document.getElementById('previewIcon');
      const darkToggle = document.getElementById('darkToggle');
      const closeBtn = document.getElementById('closeBtn');
      const styleSelect = document.getElementById('styleSelect');
      const gradeSelect = document.getElementById('gradeSelect');
      const weightSelect = document.getElementById('weightSelect');
      const fillSelect = document.getElementById('fillSelect');
      const opticalSelect = document.getElementById('opticalSelect');
      const strokeColor = document.getElementById('strokeColor');
      const insertBtn = document.getElementById('insertBtn');

      let allIconNames = [];
      let selectedIconName = null;
      let selectedSvg = '';
      let darkMode = false;
      var svgCache = {}; // key: iconName (style is requested per current styleSelect)

      const LIGHT_BG = '#ffffff';
      const DARK_BG = '#2d2d2d';

      // Sundial Design System (Slingshot AI) – one row; colors switch by light/dark mode
      var SUNDIAL_LIGHT = { Plum: '#855074', Apricot: '#8E521F', Olive: '#5F652F', Damson: '#4D675A', Cherry: '#A24335' };
      var SUNDIAL_DARK = { Plum: '#BE93B0', Apricot: '#D98F51', Olive: '#9DA64D', Damson: '#88A798', Cherry: '#C66051' };
      var SUNDIAL_NAMES = ['Plum', 'Apricot', 'Olive', 'Damson', 'Cherry'];
      var currentPresetName = 'Plum';

      var container = document.getElementById('sundialSwatchesContainer');
      function getSundialHex(name) { return darkMode ? SUNDIAL_DARK[name] : SUNDIAL_LIGHT[name]; }
      function renderSundialSwatches() {
        container.innerHTML = '';
        var wrap = document.createElement('div');
        wrap.className = 'sundial-swatches';
        SUNDIAL_NAMES.forEach(function(name) {
          var hex = getSundialHex(name);
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'sundial-swatch' + (strokeColor.value === hex ? ' active' : '');
          btn.style.background = hex;
          btn.title = name + ' (' + hex + ')';
          btn.dataset.name = name;
          btn.addEventListener('click', function() {
            currentPresetName = name;
            strokeColor.value = hex;
            container.querySelectorAll('.sundial-swatch').forEach(function(s) { s.classList.remove('active'); });
            btn.classList.add('active');
            updatePreview();
          });
          wrap.appendChild(btn);
        });
        container.appendChild(wrap);
      }
      renderSundialSwatches();

      function onStrokeColorChange() {
        currentPresetName = null;
        container.querySelectorAll('.sundial-swatch').forEach(function(s) {
          s.classList.toggle('active', s.style.background === strokeColor.value);
        });
        updatePreview();
      }

      function send(msg) {
        parent.postMessage({ pluginMessage: msg }, '*');
      }

      function hexToRgb(hex) {
        const m = hex.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
        return m ? { r: parseInt(m[1], 16), g: parseInt(m[2], 16), b: parseInt(m[3], 16) } : { r: 150, g: 135, b: 181 };
      }

      function updatePreview() {
        previewBg.style.background = darkMode ? DARK_BG : LIGHT_BG;
        darkToggle.textContent = darkMode ? '☀' : '☽';
        const color = strokeColor.value;
        previewIcon.style.color = color;
        if (!selectedSvg) {
          previewIcon.innerHTML = '';
          return;
        }
        // Material Symbols use path fill; preview shows shape in stroke color via currentColor
        const svgStr = selectedSvg.replace(/<svg/i, '<svg style="width:100%;height:100%;display:block"');
        previewIcon.innerHTML = svgStr;
      }

      darkToggle.addEventListener('click', function() {
        darkMode = !darkMode;
        if (currentPresetName) strokeColor.value = getSundialHex(currentPresetName);
        renderSundialSwatches();
        updatePreview();
      });

      strokeColor.addEventListener('input', onStrokeColorChange);
      strokeColor.addEventListener('change', onStrokeColorChange);

      send({ type: 'getIconNames' });

      window.onmessage = function(ev) {
        const msg = ev.data.pluginMessage;
        if (!msg) return;
        if (msg.type === 'iconNames') {
          allIconNames = msg.iconNames || [];
          if (gridLoading.parentNode) gridLoading.remove();
          var limitedBanner = document.getElementById('limitedBanner');
          if (allIconNames.length === 0) {
            limitedBanner.style.display = 'block';
            limitedBanner.innerHTML = '<strong>No icons loaded.</strong> Check your network and try again.';
          } else {
            limitedBanner.style.display = 'none';
          }
          renderGrid(allIconNames);
          if (allIconNames.length > 0 && !selectedIconName) {
            selectedIconName = allIconNames[0];
            requestSvgForCell(selectedIconName);
          }
        }
        if (msg.type === 'svg') {
          var name = msg.iconName;
          var style = msg.style || 'outlined';
          var svg = msg.svg || '';
          var key = name + '|' + style;
          svgCache[key] = svg;
          var cell = document.querySelector('.icon-cell[data-name="' + name + '"]');
          if (cell) {
            var wrap = cell.querySelector('.cell-svg');
            if (wrap) {
              wrap.innerHTML = svg ? (svg.replace(/<svg/i, '<svg style="width:20px;height:20px;display:block"')) : '';
            }
          }
          if (name === selectedIconName && style === styleSelect.value) {
            selectedSvg = svg;
            updatePreview();
          }
        }
      };

      function getCurrentStyle() { return styleSelect ? styleSelect.value : 'outlined'; }
      function requestSvgForCell(iconName) {
        var style = getCurrentStyle();
        send({ type: 'getSvg', payload: { iconName: iconName, style: style } });
      }
      function requestSvgsForGrid(iconNames) {
        var style = getCurrentStyle();
        iconNames.forEach(function(name) {
          var key = name + '|' + style;
          if (svgCache[key]) return;
          send({ type: 'getSvg', payload: { iconName: name, style: style } });
        });
      }

      function renderGrid(names) {
        iconGrid.innerHTML = '';
        var style = getCurrentStyle();
        var list = names.slice(0, 80);
        list.forEach(function(name) {
          var cell = document.createElement('div');
          cell.className = 'icon-cell' + (name === selectedIconName ? ' selected' : '');
          cell.dataset.name = name;
          var key = name + '|' + style;
          var cached = svgCache[key];
          var svgHtml = cached ? cached.replace(/<svg/i, '<svg style="width:20px;height:20px;display:block"') : '';
          cell.innerHTML = '<div class="cell-svg">' + svgHtml + '</div>';
          cell.addEventListener('click', function() {
            document.querySelectorAll('.icon-cell.selected').forEach(function(c) { c.classList.remove('selected'); });
            cell.classList.add('selected');
            selectedIconName = name;
            var key = name + '|' + getCurrentStyle();
            if (svgCache[key]) {
              selectedSvg = svgCache[key];
              updatePreview();
            } else {
              requestSvgForCell(name);
            }
          });
          iconGrid.appendChild(cell);
        });
        requestSvgsForGrid(list);
        if (names.length > 80) {
          var more = document.createElement('div');
          more.className = 'loading';
          more.style.gridColumn = '1 / -1';
          more.textContent = 'Search to find more (' + names.length + ' total)';
          iconGrid.appendChild(more);
        }
      }

      function runSearch() {
        var q = (searchEl.value || '').toLowerCase().trim();
        var filtered = q ? allIconNames.filter(function(n) { return n.toLowerCase().indexOf(q) !== -1; }) : allIconNames;
        renderGrid(filtered);
      }
      searchEl.addEventListener('input', runSearch);
      searchEl.addEventListener('keyup', runSearch);

      styleSelect.addEventListener('change', function() {
        runSearch();
        if (selectedIconName) requestSvgForCell(selectedIconName);
      });

      closeBtn.addEventListener('click', function() {
        send({ type: 'close' });
      });

      var rightCol = document.getElementById('rightCol');
      var expandToggle = document.getElementById('expandToggle');
      if (rightCol && expandToggle) {
        expandToggle.addEventListener('click', function() {
          rightCol.classList.toggle('collapsed');
          expandToggle.innerHTML = rightCol.classList.contains('collapsed') ? '&#9654;' : '&#9664;';
          expandToggle.title = rightCol.classList.contains('collapsed') ? 'Expand preview panel' : 'Collapse preview panel';
        });
      }

      insertBtn.addEventListener('click', function() {
        if (!selectedIconName) {
          alert('Select an icon first.');
          return;
        }
        var scale = parseInt(opticalSelect.value, 10) || 24;
        var weight = parseInt(weightSelect.value, 10) || 400;
        var rgb = hexToRgb(strokeColor.value);
        send({
          type: 'insert',
          payload: {
            iconName: selectedIconName,
            style: getCurrentStyle(),
            weight: weight,
            grade: gradeSelect ? gradeSelect.value : 'normal',
            fill: fillSelect ? fillSelect.value : 'off',
            strokeWeight: weightToStrokeWeight(weight),
            strokeColor: rgb,
            strokeAlign: 'CENTER',
            scale: scale,
            strokeStyle: 'basic'
          }
        });
      });
      function weightToStrokeWeight(w) {
        var map = { 100: 0.5, 200: 0.75, 300: 1, 400: 1.25, 500: 1.5, 600: 1.75, 700: 2 };
        return map[w] != null ? map[w] : 1.25;
      }

      updatePreview();
    })();
  </script>
</body>
</html>
