<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 11px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
    }
    section { margin-bottom: 12px; }
    label { display: block; margin-bottom: 4px; font-weight: 500; }
    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
    }
    input[type="color"] { width: 100%; height: 28px; padding: 0; border: 1px solid var(--figma-color-border); border-radius: 4px; cursor: pointer; }
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      cursor: pointer;
      font-weight: 500;
    }
    button:hover { opacity: 0.9; }
    button.secondary { background: var(--figma-color-bg-secondary); color: var(--figma-color-text); }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .row label { margin-bottom: 0; }
    .icon-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
      flex: 1;
      min-height: 180px;
      max-height: 320px;
      overflow-y: auto;
      padding: 6px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
    }
    .icon-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      background: var(--figma-color-bg);
      border: 1px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      color: var(--figma-color-text);
      text-align: center;
      word-break: break-word;
    }
    .icon-cell:hover { border-color: var(--figma-color-border-strong); background: var(--figma-color-bg-hover); }
    .icon-cell.selected { border-color: var(--figma-color-bg-brand); background: var(--figma-color-bg-brand-tertiary); }
    .icon-cell svg { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; flex-shrink: 0; }
    .preview-wrap {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--figma-color-border);
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .preview-wrap .preview-bg {
      position: absolute;
      inset: 0;
      transition: background 0.2s;
    }
    .preview-wrap .preview-icon {
      position: relative;
      z-index: 1;
      width: 48px;
      height: 48px;
    }
    .preview-wrap .preview-icon svg { width: 100%; height: 100%; display: block; }
    .preview-wrap .preview-icon svg path,
    .preview-wrap .preview-icon svg circle,
    .preview-wrap .preview-icon svg line { fill: none; stroke: currentColor; }
    .dark-toggle {
      position: absolute;
      top: 6px;
      right: 6px;
      z-index: 2;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px solid var(--figma-color-border);
      background: var(--figma-color-bg);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .dark-toggle:hover { background: var(--figma-color-bg-hover); }
    .stroke-style-tabs { display: flex; gap: 4px; margin-bottom: 8px; }
    .stroke-style-tabs button { flex: 1; padding: 6px 8px; font-size: 10px; }
    .stroke-style-tabs button.active { background: var(--figma-color-bg-brand); color: var(--figma-color-text-onbrand); }
    .scale-options { display: flex; gap: 6px; }
    .scale-options label { display: flex; align-items: center; gap: 4px; cursor: pointer; }
    .scale-options input[type="radio"] { width: auto; }
    .insert-row { margin-top: 12px; display: flex; justify-content: stretch; }
    .insert-row button { flex: 1; }
    .loading { color: var(--figma-color-text-secondary); padding: 8px; }

    /* Lucide Icons layout */
    .ui-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0 12px;
      border-bottom: 1px solid var(--figma-color-border);
      margin-bottom: 12px;
    }
    .ui-header-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--figma-color-text);
    }
    .ui-header-logo {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #fff;
      font-size: 12px;
      font-weight: bold;
    }
    .ui-header-close {
      width: 28px;
      height: 28px;
      padding: 0;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--figma-color-text-secondary);
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .ui-header-close:hover {
      background: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
    }
    .search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .style-select-wrap { flex: 0 0 100px; }
    .style-select-wrap label,
    .search-wrap label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 10px; color: var(--figma-color-text-secondary); }
    .search-wrap { flex: 1; min-width: 0; }
    .search-input-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
    }
    .search-input-wrap:focus-within { border-color: var(--figma-color-border-strong); outline: none; }
    .search-input-wrap svg { flex-shrink: 0; width: 14px; height: 14px; stroke: var(--figma-color-text-secondary); }
    .search-input-wrap input {
      border: none;
      background: transparent;
      flex: 1;
      min-width: 0;
      padding: 0;
      font-size: 11px;
      color: var(--figma-color-text);
    }
    .search-input-wrap input::placeholder { color: var(--figma-color-text-secondary); }
    .search-input-wrap input:focus { outline: none; }
    .filters-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 16px;
      margin-bottom: 12px;
    }
    .filter-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 10px;
      color: var(--figma-color-text-secondary);
    }
    .filter-group select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 11px;
    }
    .filter-hint {
      display: block;
      margin-top: 2px;
      font-size: 9px;
      color: var(--figma-color-text-secondary);
    }
    .icon-grid-wrap .icon-grid { margin-bottom: 0; }
    .icon-grid-wrap .section-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 10px;
      color: var(--figma-color-text-secondary);
    }
    /* Two-column: grid left, preview + below right */
    .main-layout {
      display: flex;
      gap: 12px;
      min-height: 0;
    }
    .left-col {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    .icon-grid-wrap { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .right-col {
      width: 160px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--figma-color-border);
      padding-left: 12px;
      transition: width 0.2s ease, padding 0.2s ease, min-width 0.2s ease;
      overflow: hidden;
    }
    .right-col.collapsed {
      width: 36px;
      min-width: 36px;
      padding-left: 4px;
      padding-right: 4px;
      border-left: 1px solid var(--figma-color-border);
    }
    .right-col.collapsed .right-col-content { display: none; }
    .expand-toggle {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      padding: 0;
      border: none;
      border-radius: 4px;
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-secondary);
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
    }
    .expand-toggle:hover { background: var(--figma-color-bg-hover); color: var(--figma-color-text); }
    .right-col.collapsed .expand-toggle { margin-left: 4px; }
    .right-col section { margin-bottom: 10px; }
    .right-col .preview-wrap { min-height: 80px; }
    .right-col .preview-wrap .preview-icon { width: 40px; height: 40px; }
    .icon-cell .cell-svg { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    .icon-cell .cell-svg svg { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; }
    .banner {
      padding: 8px 10px;
      border-radius: 6px;
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 10px;
    }
    .banner strong { color: var(--figma-color-text); }
    .sundial-label { margin-bottom: 6px; font-weight: 500; }
    .sundial-label small { font-weight: normal; color: var(--figma-color-text-secondary); }
    .sundial-swatches { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
    .sundial-swatch {
      width: 28px; height: 28px; border-radius: 6px; border: 2px solid var(--figma-color-border);
      cursor: pointer; flex-shrink: 0;
    }
    .sundial-swatch:hover { border-color: var(--figma-color-border-strong); }
    .sundial-swatch.active { border-color: var(--figma-color-bg-brand); box-shadow: 0 0 0 1px var(--figma-color-bg-brand); }
    .sundial-row { margin-bottom: 6px; }
    .sundial-row span { font-size: 10px; color: var(--figma-color-text-secondary); display: block; margin-bottom: 4px; }
    .preview-style-label {
      margin-top: 6px;
      font-size: 10px;
      color: var(--figma-color-text-secondary);
    }
  </style>
</head>
<body>
  <header class="ui-header">
    <div class="ui-header-title">
      <div class="ui-header-logo" title="Ash Icon Studio">L</div>
      <span>Ash Icon Studio</span>
    </div>
    <button type="button" class="ui-header-close" id="closeBtn" title="Close">×</button>
  </header>

  <div class="main-layout">
    <div class="left-col">
  <div id="limitedBanner" class="banner" style="display:none;">
    <strong>No icons loaded.</strong> Run <code>npm run build</code> to generate the icon set from Lucide.
  </div>

  <div class="search-row">
    <div class="search-wrap" style="flex: 1;">
      <label for="search">Search</label>
      <div class="search-input-wrap">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <input type="text" id="search" placeholder="Search Ash icons" />
      </div>
    </div>
  </div>

  <div class="filters-row">
    <div class="filter-group">
      <label for="strokeWeightSelect">Stroke</label>
      <select id="strokeWeightSelect">
        <option value="1">1</option>
        <option value="1.5">1.5</option>
        <option value="2" selected>2</option>
      </select>
      <span class="filter-hint">Stroke width</span>
    </div>
    <div class="filter-group">
      <label for="opticalSelect">Size</label>
      <select id="opticalSelect">
        <option value="12">12</option>
        <option value="16">16</option>
        <option value="20">20</option>
        <option value="24" selected>24</option>
        <option value="32">32</option>
        <option value="40">40</option>
        <option value="48">48</option>
        <option value="64">64</option>
        <option value="80">80</option>
        <option value="96">96</option>
        <option value="128">128</option>
      </select>
      <span class="filter-hint">Icon size (px)</span>
    </div>
  </div>

  <section class="icon-grid-wrap">
    <span class="section-label">Icons</span>
    <div id="iconGrid" class="icon-grid">
      <div class="loading" id="gridLoading">Loading icons…</div>
    </div>
  </section>
    </div>

    <div class="right-col" id="rightCol">
      <button type="button" class="expand-toggle" id="expandToggle" title="Collapse preview panel">&#9664;</button>
      <div class="right-col-content">
  <section>
    <label>Preview</label>
    <div class="preview-wrap" id="previewWrap">
      <div class="preview-bg" id="previewBg"></div>
      <button type="button" class="dark-toggle" id="darkToggle" title="Toggle light/dark">☀</button>
      <div class="preview-icon" id="previewIcon"></div>
    </div>
    <div id="previewStyleLabel" class="preview-style-label"></div>
  </section>
  <section>
    <label class="sundial-label">Color</label>
    <div id="sundialSwatchesContainer"></div>
    <input type="color" id="strokeColor" value="#855074" />
  </section>
  <section>
    <label for="strokeStyleSelect">Stroke style</label>
    <select id="strokeStyleSelect">
      <option value="">Basic</option>
      <option value="HEIST">1 — Heist</option>
      <option value="BIOPIC">2 — Biopic</option>
      <option value="EPIC">3 — Epic</option>
      <option value="VERITE">4 — Verite</option>
      <option value="PROPAGANDA">5 — Propaganda</option>
    </select>
    <span class="filter-hint">Brush applied to icon stroke</span>
  </section>
  <section class="insert-row">
    <button type="button" id="insertBtn">Insert on canvas</button>
  </section>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const searchEl = document.getElementById('search');
      const iconGrid = document.getElementById('iconGrid');
      const gridLoading = document.getElementById('gridLoading');
      const previewWrap = document.getElementById('previewWrap');
      const previewBg = document.getElementById('previewBg');
      const previewIcon = document.getElementById('previewIcon');
      const darkToggle = document.getElementById('darkToggle');
      const closeBtn = document.getElementById('closeBtn');
      const strokeWeightSelect = document.getElementById('strokeWeightSelect');
      const opticalSelect = document.getElementById('opticalSelect');
      const strokeColor = document.getElementById('strokeColor');
      const strokeStyleSelect = document.getElementById('strokeStyleSelect');
      const previewStyleLabel = document.getElementById('previewStyleLabel');
      const insertBtn = document.getElementById('insertBtn');

      var STROKE_STYLE_LABELS = { '': 'Basic', 'HEIST': 'Heist', 'BIOPIC': 'Biopic', 'EPIC': 'Epic', 'VERITE': 'Verite', 'PROPAGANDA': 'Propaganda' };

      let allIconNames = [];
      let selectedIconName = null;
      let selectedSvg = '';
      let darkMode = false;
      var svgCache = {}; // key: iconName
      var insertReenableTimeoutId = null;

      const LIGHT_BG = '#ffffff';
      const DARK_BG = '#2d2d2d';

      // Sundial Design System (Slingshot AI) – one row; colors switch by light/dark mode
      var SUNDIAL_LIGHT = { Plum: '#855074', Apricot: '#8E521F', Olive: '#5F652F', Damson: '#4D675A', Cherry: '#A24335' };
      var SUNDIAL_DARK = { Plum: '#BE93B0', Apricot: '#D98F51', Olive: '#9DA64D', Damson: '#88A798', Cherry: '#C66051' };
      var SUNDIAL_NAMES = ['Plum', 'Apricot', 'Olive', 'Damson', 'Cherry'];
      var currentPresetName = 'Plum';

      var container = document.getElementById('sundialSwatchesContainer');
      function getSundialHex(name) { return darkMode ? SUNDIAL_DARK[name] : SUNDIAL_LIGHT[name]; }
      function renderSundialSwatches() {
        container.innerHTML = '';
        var wrap = document.createElement('div');
        wrap.className = 'sundial-swatches';
        SUNDIAL_NAMES.forEach(function(name) {
          var hex = getSundialHex(name);
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'sundial-swatch' + (strokeColor.value === hex ? ' active' : '');
          btn.style.background = hex;
          btn.title = name + ' (' + hex + ')';
          btn.dataset.name = name;
          btn.addEventListener('click', function() {
            currentPresetName = name;
            strokeColor.value = hex;
            container.querySelectorAll('.sundial-swatch').forEach(function(s) { s.classList.remove('active'); });
            btn.classList.add('active');
            updatePreview();
          });
          wrap.appendChild(btn);
        });
        container.appendChild(wrap);
      }
      renderSundialSwatches();

      function onStrokeColorChange() {
        currentPresetName = null;
        container.querySelectorAll('.sundial-swatch').forEach(function(s) {
          s.classList.toggle('active', s.style.background === strokeColor.value);
        });
        updatePreview();
      }

      function send(msg) {
        parent.postMessage({ pluginMessage: msg }, '*');
      }

      function triggerInsert() {
        if (!selectedIconName) {
          alert('Select an icon first.');
          return;
        }
        if (insertBtn.disabled) return;
        insertBtn.disabled = true;
        insertBtn.textContent = 'Inserting…';
        if (insertReenableTimeoutId) clearTimeout(insertReenableTimeoutId);
        insertReenableTimeoutId = setTimeout(function() {
          insertReenableTimeoutId = null;
          insertBtn.disabled = false;
          insertBtn.textContent = 'Insert on canvas';
        }, 3000);
        var scale = parseInt(opticalSelect.value, 10) || 24;
        var strokeWeight = parseFloat(strokeWeightSelect ? strokeWeightSelect.value : '2') || 2;
        var strokeStyle = strokeStyleSelect ? strokeStyleSelect.value : '';
        var rgb = hexToRgb(strokeColor.value);
        send({
          type: 'insert',
          payload: {
            iconName: selectedIconName,
            strokeWeight: strokeWeight,
            strokeColor: rgb,
            scale: scale,
            strokeStyle: strokeStyle
          }
        });
      }

      function hexToRgb(hex) {
        const m = hex.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
        return m ? { r: parseInt(m[1], 16), g: parseInt(m[2], 16), b: parseInt(m[3], 16) } : { r: 150, g: 135, b: 181 };
      }

      function updatePreview() {
        previewBg.style.background = darkMode ? DARK_BG : LIGHT_BG;
        darkToggle.textContent = darkMode ? '☀' : '☽';
        var color = strokeColor.value;
        previewIcon.style.color = color;
        var styleVal = strokeStyleSelect ? strokeStyleSelect.value : '';
        var styleLabel = STROKE_STYLE_LABELS[styleVal] || 'Basic';
        previewStyleLabel.textContent = styleVal ? 'Stroke: ' + styleLabel + ' (applies on insert)' : 'Stroke: Basic';
        var sizePx = parseInt(opticalSelect && opticalSelect.value ? opticalSelect.value : '24', 10) || 24;
        var strokeW = parseFloat(strokeWeightSelect && strokeWeightSelect.value ? strokeWeightSelect.value : '2') || 2;
        previewIcon.style.width = Math.round(sizePx * 2) + 'px';
        previewIcon.style.height = Math.round(sizePx * 2) + 'px';
        if (!selectedSvg) {
          previewIcon.innerHTML = '';
          return;
        }
        var svgStr = selectedSvg.replace(/<svg/i, '<svg style="width:100%;height:100%;display:block"');
        svgStr = svgStr.replace(/stroke-width="[^"]*"/i, 'stroke-width="' + strokeW + '"');
        if (!/stroke-width=/i.test(svgStr)) svgStr = svgStr.replace(/<svg/i, '<svg stroke-width="' + strokeW + '"');
        svgStr = svgStr.replace(/stroke="currentColor"/gi, 'stroke="' + color + '"');
        previewIcon.innerHTML = svgStr;
      }

      darkToggle.addEventListener('click', function() {
        darkMode = !darkMode;
        if (currentPresetName) strokeColor.value = getSundialHex(currentPresetName);
        renderSundialSwatches();
        updatePreview();
      });

      strokeColor.addEventListener('input', onStrokeColorChange);
      strokeColor.addEventListener('change', onStrokeColorChange);
      if (opticalSelect) {
        opticalSelect.addEventListener('change', updatePreview);
        opticalSelect.addEventListener('input', updatePreview);
      }
      if (strokeWeightSelect) {
        strokeWeightSelect.addEventListener('change', updatePreview);
        strokeWeightSelect.addEventListener('input', updatePreview);
      }
      if (strokeStyleSelect) {
        strokeStyleSelect.addEventListener('change', function() {
          updatePreview();
          var val = strokeStyleSelect.value;
          if (val) {
            send({ type: 'preloadBrushes', payload: { strokeStyle: val } });
          }
        });
        strokeStyleSelect.addEventListener('input', function() {
          updatePreview();
          var val = strokeStyleSelect.value;
          if (val) {
            send({ type: 'preloadBrushes', payload: { strokeStyle: val } });
          }
        });
      }

      send({ type: 'getIconNames' });

      window.onmessage = function(ev) {
        const msg = ev.data.pluginMessage;
        if (!msg) return;
        if (msg.type === 'insertDone') {
          if (insertReenableTimeoutId) clearTimeout(insertReenableTimeoutId);
          insertReenableTimeoutId = null;
          insertBtn.disabled = false;
          insertBtn.textContent = 'Insert on canvas';
          return;
        }
        if (msg.type === 'iconNames') {
          allIconNames = msg.iconNames || [];
          if (gridLoading.parentNode) gridLoading.remove();
          var limitedBanner = document.getElementById('limitedBanner');
          if (allIconNames.length === 0) {
            limitedBanner.style.display = 'block';
            limitedBanner.innerHTML = '<strong>No icons loaded.</strong> Check your network and try again.';
          } else {
            limitedBanner.style.display = 'none';
          }
          renderGrid(allIconNames);
          if (allIconNames.length > 0 && !selectedIconName) {
            selectedIconName = allIconNames[0];
            requestSvgForCell(selectedIconName);
          }
        }
        if (msg.type === 'svg') {
          var name = msg.iconName;
          var svg = msg.svg || '';
          svgCache[name] = svg;
          var cell = document.querySelector('.icon-cell[data-name="' + name + '"]');
          if (cell) {
            var wrap = cell.querySelector('.cell-svg');
            if (wrap) {
              wrap.innerHTML = svg ? (svg.replace(/<svg/i, '<svg style="width:20px;height:20px;display:block"')) : '';
            }
          }
          if (name === selectedIconName) {
            selectedSvg = svg;
            updatePreview();
          }
        }
      };

      function requestSvgForCell(iconName) {
        send({ type: 'getSvg', payload: { iconName: iconName } });
      }
      function requestSvgsForGrid(iconNames) {
        iconNames.forEach(function(name) {
          if (svgCache[name]) return;
          send({ type: 'getSvg', payload: { iconName: name } });
        });
      }

      function renderGrid(names) {
        iconGrid.innerHTML = '';
        var list = names.slice(0, 80);
        list.forEach(function(name) {
          var cell = document.createElement('div');
          cell.className = 'icon-cell' + (name === selectedIconName ? ' selected' : '');
          cell.dataset.name = name;
          var cached = svgCache[name];
          var svgHtml = cached ? cached.replace(/<svg/i, '<svg style="width:20px;height:20px;display:block"') : '';
          cell.innerHTML = '<div class="cell-svg">' + svgHtml + '</div>';
          cell.addEventListener('click', function() {
            document.querySelectorAll('.icon-cell.selected').forEach(function(c) { c.classList.remove('selected'); });
            cell.classList.add('selected');
            selectedIconName = name;
            if (svgCache[name]) {
              selectedSvg = svgCache[name];
              updatePreview();
            } else {
              selectedSvg = '';
              updatePreview();
              requestSvgForCell(name);
            }
          });
          iconGrid.appendChild(cell);
        });
        requestSvgsForGrid(list);
        if (names.length > 80) {
          var more = document.createElement('div');
          more.className = 'loading';
          more.style.gridColumn = '1 / -1';
          more.textContent = 'Search to find more (' + names.length + ' total)';
          iconGrid.appendChild(more);
        }
      }

      function runSearch() {
        var q = (searchEl.value || '').toLowerCase().trim();
        var filtered = q ? allIconNames.filter(function(n) { return n.toLowerCase().indexOf(q) !== -1; }) : allIconNames;
        renderGrid(filtered);
      }
      searchEl.addEventListener('input', runSearch);
      searchEl.addEventListener('keyup', runSearch);

      closeBtn.addEventListener('click', function() {
        send({ type: 'close' });
      });

      var rightCol = document.getElementById('rightCol');
      var expandToggle = document.getElementById('expandToggle');
      if (rightCol && expandToggle) {
        expandToggle.addEventListener('click', function() {
          rightCol.classList.toggle('collapsed');
          expandToggle.innerHTML = rightCol.classList.contains('collapsed') ? '&#9654;' : '&#9664;';
          expandToggle.title = rightCol.classList.contains('collapsed') ? 'Expand preview panel' : 'Collapse preview panel';
        });
      }

      if (strokeStyleSelect) strokeStyleSelect.addEventListener('change', updatePreview);
      if (strokeStyleSelect) strokeStyleSelect.addEventListener('input', updatePreview);

      insertBtn.addEventListener('click', function() {
        triggerInsert();
      });

      updatePreview();
    })();
  </script>
</body>
</html>
